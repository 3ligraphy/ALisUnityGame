# CodeMagic Configuration for Unity iOS Build
# This configuration is optimized for Unity Personal (Free) license with Gmail login
# 
# ⚠️ SECURITY WARNING: This file contains your Unity credentials directly in the YAML file.
# This means your password will be visible in your Git repository!
# 
# RECOMMENDED: Use environment variables instead (more secure):
# 1. Go to CodeMagic dashboard > Your App > Settings > Environment variables
# 2. Add UNITY_EMAIL and UNITY_PASSWORD as secure environment variables
# 3. Remove the values below and use ${UNITY_EMAIL} and ${UNITY_PASSWORD} instead
#
# If you must use direct values, consider:
# - Adding codemagic.yaml to .gitignore (but then you can't version control it)
# - Using a private repository
# - Changing your Unity password after sharing this file
#
# TO USE THIS FILE: Replace the placeholder values below with your actual credentials

workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      vars:
        # Unity version - matches your project version
        UNITY_VERSION: "6000.2.15f1"
        
        # Unity Personal License - NO SERIAL NUMBER NEEDED!
        # For Personal license, leave UNITY_SERIAL empty or don't set it
        # Only Plus/Pro licenses need a serial number
        # UNITY_SERIAL: ""  # Leave empty for Personal license
        
        # Unity account credentials - REPLACE WITH YOUR ACTUAL VALUES
        # ⚠️ WARNING: These will be visible in your Git repository!
        UNITY_EMAIL: "amohamad343@gmail.com"  # ⚠️ REPLACE with your Gmail address
        UNITY_PASSWORD: "AJ1422003249aj*"      # ⚠️ REPLACE with your Unity password
        
        # Bundle identifier - already configured for your app
        BUNDLE_ID: "com.failaka.games.adventure"
        
        # App Store Connect App ID (optional - for automatic TestFlight uploads)
        # APP_STORE_ID: ""  # Add this later if you want automatic uploads
        
      xcode: latest
      cocoapods: default
      
    scripts:
      - name: Install Unity
        script: |
          echo "=========================================="
          echo "Installing Unity ${UNITY_VERSION}..."
          echo "=========================================="
          
          # Check if Unity is already installed
          if [ -f "/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity/Unity.app/Contents/MacOS/Unity" ]; then
            echo "✅ Unity ${UNITY_VERSION} is already installed"
            exit 0
          fi
          
          # Check for any Unity installation
          EXISTING_UNITY=$(find /Applications -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
          if [ -n "$EXISTING_UNITY" ]; then
            echo "⚠️  Found existing Unity installation at: $EXISTING_UNITY"
            echo "Will try to use it if version ${UNITY_VERSION} is not available"
          fi
          
          echo "Downloading Unity ${UNITY_VERSION} installer..."
          
          # Create temp directory
          mkdir -p /tmp/unity_install
          cd /tmp/unity_install
          
          # Try multiple download URLs
          UNITY_URLS=(
            "https://download.unity3d.com/download_unity/${UNITY_VERSION}/MacEditorInstaller/Unity-${UNITY_VERSION}.pkg"
            "https://beta.unity3d.com/download/${UNITY_VERSION}/MacEditorInstaller/Unity-${UNITY_VERSION}.pkg"
            "https://download.unity3d.com/download_unity/${UNITY_VERSION}/MacEditorInstaller/Unity.pkg"
          )
          
          DOWNLOAD_SUCCESS=false
          for URL in "${UNITY_URLS[@]}"; do
            echo "Trying: $URL"
            if curl -L -f -o unity.pkg "$URL" 2>/dev/null; then
              echo "✅ Download successful from: $URL"
              DOWNLOAD_SUCCESS=true
              break
            else
              echo "❌ Failed to download from: $URL"
            fi
          done
          
          if [ "$DOWNLOAD_SUCCESS" = false ]; then
            echo "❌ Failed to download Unity installer from all URLs"
            echo ""
            echo "Possible solutions:"
            echo "1. Check if Unity version ${UNITY_VERSION} is available"
            echo "2. Unity version might need to be installed manually"
            echo "3. Try using a different Unity version"
            echo ""
            echo "If you have Unity Hub installed, you can install Unity manually:"
            echo "  - Open Unity Hub"
            echo "  - Go to Installs tab"
            echo "  - Install Unity ${UNITY_VERSION}"
            exit 1
          fi
          
          # Install Unity
          echo "Installing Unity package..."
          sudo installer -pkg unity.pkg -target / -allowUntrusted -verboseR || {
            echo "❌ Failed to install Unity package"
            echo "Trying with different installer options..."
            sudo installer -pkg unity.pkg -target / -verboseR || {
              echo "❌ Installation failed completely"
              exit 1
            }
          }
          
          # Clean up
          cd /
          rm -rf /tmp/unity_install
          
          # Wait a moment for installation to complete
          sleep 2
          
          # Verify installation
          echo "Verifying Unity installation..."
          if [ -f "/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity/Unity.app/Contents/MacOS/Unity" ]; then
            echo "✅ Unity ${UNITY_VERSION} installed successfully at Hub location"
          elif [ -f "/Applications/Unity/Unity.app/Contents/MacOS/Unity" ]; then
            echo "✅ Unity installed at /Applications/Unity/Unity.app"
          else
            echo "⚠️  Unity installed but not found at expected paths"
            echo "Searching for Unity installation..."
            find /Applications -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | while read path; do
              echo "Found: $path"
            done
            echo ""
            echo "⚠️  Continuing anyway - build step will try to find Unity"
          fi
          
      - name: Build Unity Project for iOS
        script: |
          echo "=========================================="
          echo "Building Unity project for iOS..."
          echo "Using Unity Personal License (Free)"
          echo "=========================================="
          
          set -e
          
          # Find Unity executable (should be installed by previous step)
          UNITY_PATH=""
          
          # Check Unity Hub location first (most common)
          if [ -f "/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity/Unity.app/Contents/MacOS/Unity" ]; then
            UNITY_PATH="/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity/Unity.app/Contents/MacOS/Unity"
            echo "Found Unity in Hub location"
          # Check for direct Unity installation
          elif [ -f "/Applications/Unity/Unity.app/Contents/MacOS/Unity" ]; then
            UNITY_PATH="/Applications/Unity/Unity.app/Contents/MacOS/Unity"
            echo "Found Unity in direct installation location"
          # Try to find Unity anywhere in /Applications
          else
            echo "Searching for Unity in /Applications..."
            UNITY_PATH=$(find /Applications -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
            if [ -n "$UNITY_PATH" ]; then
              echo "Found Unity at: $UNITY_PATH"
            fi
          fi
          
          # If still not found, try to use any Unity version
          if [ -z "$UNITY_PATH" ]; then
            echo "⚠️  Unity ${UNITY_VERSION} not found, searching for any Unity version..."
            UNITY_PATH=$(find /Applications -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
            if [ -n "$UNITY_PATH" ]; then
              echo "⚠️  Using different Unity version found at: $UNITY_PATH"
            fi
          fi
          
          # Final check
          if [ -z "$UNITY_PATH" ] || [ ! -f "$UNITY_PATH" ]; then
            echo "❌ Error: Unity executable not found!"
            echo "Searched locations:"
            echo "  - /Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity/Unity.app/Contents/MacOS/Unity"
            echo "  - /Applications/Unity/Unity.app/Contents/MacOS/Unity"
            echo ""
            echo "Please check the Unity installation step above for errors."
            exit 1
          fi
          
          echo "✅ Using Unity at: $UNITY_PATH"
          
          # Verify Unity version (optional check)
          UNITY_ACTUAL_VERSION=$("$UNITY_PATH" -version 2>&1 | head -1 || echo "unknown")
          echo "Unity version: $UNITY_ACTUAL_VERSION"
          
          # Build Unity project for iOS
          # For Personal license, we don't use -serial parameter
          echo "Starting Unity build (this may take 10-20 minutes)..."
          
          $UNITY_PATH \
            -quit \
            -batchmode \
            -nographics \
            -projectPath "$CM_BUILD_DIR" \
            -buildTarget iOS \
            -buildPath "$CM_BUILD_DIR/build/ios" \
            -username "${UNITY_EMAIL}" \
            -password "${UNITY_PASSWORD}" \
            -logFile "$CM_BUILD_DIR/unity_build.log" \
            || true
          
          # Check build result
          echo "=========================================="
          echo "Checking build log..."
          echo "=========================================="
          
          if [ -f "$CM_BUILD_DIR/unity_build.log" ]; then
            if grep -q "Build succeeded" "$CM_BUILD_DIR/unity_build.log"; then
              echo "✅ Unity build succeeded!"
            elif grep -q "Build failed" "$CM_BUILD_DIR/unity_build.log"; then
              echo "❌ Unity build failed. Last 50 lines of log:"
              tail -50 "$CM_BUILD_DIR/unity_build.log"
              exit 1
            else
              echo "⚠️  Build status unclear. Checking for Xcode project..."
              # Check if Xcode project was created
              if [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcodeproj" ] || [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcworkspace" ]; then
                echo "✅ Xcode project found - build likely succeeded"
              ls -la "$CM_BUILD_DIR/build/ios/"
              else
                echo "❌ Xcode project not found. Last 100 lines of log:"
                tail -100 "$CM_BUILD_DIR/unity_build.log"
                exit 1
              fi
            fi
          else
            echo "⚠️  Build log not found, but continuing..."
          fi
          
      - name: Configure Xcode Project
        script: |
          echo "=========================================="
          echo "Configuring Xcode project..."
          echo "=========================================="
          
          set -e
          cd "$CM_BUILD_DIR/build/ios"
          
          # Verify Xcode project exists
          if [ ! -d "Unity-iPhone.xcodeproj" ] && [ ! -d "Unity-iPhone.xcworkspace" ]; then
            echo "❌ Error: Xcode project not found!"
            echo "Contents of build/ios directory:"
            ls -la
            exit 1
          fi
          
          echo "✅ Xcode project found"
          
          # Find Info.plist
          INFO_PLIST=""
          if [ -f "Unity-iPhone/Info.plist" ]; then
            INFO_PLIST="Unity-iPhone/Info.plist"
          elif [ -f "Info.plist" ]; then
            INFO_PLIST="Info.plist"
          else
            INFO_PLIST=$(find . -name Info.plist -type f | head -1)
          fi
          
          if [ -z "$INFO_PLIST" ] || [ ! -f "$INFO_PLIST" ]; then
            echo "⚠️  Warning: Info.plist not found, but continuing..."
          else
            echo "Updating Info.plist: $INFO_PLIST"
            
            # Set bundle identifier
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set bundle identifier"
            
            # Set version
            /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set version"
            
            # Set build number (uses CodeMagic build number)
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${CM_BUILD_NUMBER}" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string ${CM_BUILD_NUMBER}" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set build number"
            
            # Set minimum iOS version
            /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 13.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 13.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set minimum iOS version"
            
            echo "✅ Info.plist updated"
            echo "Bundle ID: ${BUNDLE_ID}"
            echo "Version: 1.0.0"
            echo "Build Number: ${CM_BUILD_NUMBER}"
          fi
          
      - name: Install CocoaPods Dependencies
        script: |
          echo "=========================================="
          echo "Installing CocoaPods dependencies..."
          echo "=========================================="
          
          cd "$CM_BUILD_DIR/build/ios"
          
          # Check if Podfile exists (Unity sometimes creates one)
          if [ -f "Podfile" ]; then
            echo "Podfile found, installing dependencies..."
            pod install --repo-update || echo "⚠️  CocoaPods installation had issues, but continuing..."
          else
            echo "No Podfile found - this is normal for most Unity projects"
            echo "Skipping CocoaPods installation"
          fi
          
      - name: Build Xcode Archive
        script: |
          echo "=========================================="
          echo "Building Xcode archive..."
          echo "=========================================="
          
          set -e
          cd "$CM_BUILD_DIR/build/ios"
          
          # Determine if we have workspace or project
          if [ -d "Unity-iPhone.xcworkspace" ]; then
            echo "Using Xcode workspace"
            WORKSPACE="Unity-iPhone.xcworkspace"
            SCHEME="Unity-iPhone"
            
            # CodeMagic will handle code signing automatically during export
            # We build without signing here, signing happens during IPA export
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
              archive \
              -quiet
              
          elif [ -d "Unity-iPhone.xcodeproj" ]; then
            echo "Using Xcode project"
            PROJECT="Unity-iPhone.xcodeproj"
            SCHEME="Unity-iPhone"
            
            # CodeMagic will handle code signing automatically during export
            xcodebuild \
              -project "$PROJECT" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
              archive \
              -quiet
          else
            echo "❌ Error: No Xcode project or workspace found"
            echo "Contents of build/ios:"
            ls -la
            exit 1
          fi
          
          # Verify archive was created
          if [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" ]; then
            echo "✅ Archive created successfully"
          else
            echo "❌ Error: Archive not created"
            exit 1
          fi
          
      - name: Export IPA
        script: |
          echo "=========================================="
          echo "Exporting IPA file..."
          echo "=========================================="
          
          set -e
          
          # Check if exportOptions.plist exists in project root
          if [ ! -f "$CM_BUILD_DIR/exportOptions.plist" ]; then
            echo "Creating exportOptions.plist for automatic code signing..."
            cat > "$CM_BUILD_DIR/exportOptions.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
          </dict>
          </plist>
          EOF
            echo "✅ Created exportOptions.plist with automatic signing"
          else
            echo "✅ Using existing exportOptions.plist"
            # Ensure automatic signing is set
            /usr/libexec/PlistBuddy -c "Set :signingStyle automatic" "$CM_BUILD_DIR/exportOptions.plist" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :signingStyle string automatic" "$CM_BUILD_DIR/exportOptions.plist" 2>/dev/null || \
            echo "⚠️  Could not set signingStyle, but continuing..."
          fi
          
          # Export IPA with automatic code signing
          # CodeMagic will use the Apple Developer integration you configured
          echo "Exporting archive to IPA with automatic code signing..."
          echo "CodeMagic will use your Apple Developer integration for signing..."
          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
            -exportPath "$CM_BUILD_DIR/build/ios/export" \
            -exportOptionsPlist "$CM_BUILD_DIR/exportOptions.plist" \
            -quiet || {
              echo "❌ IPA export failed"
              echo "Check that:"
              echo "1. Apple Developer integration is configured in CodeMagic Settings > Integrations"
              echo "2. Your bundle ID matches the one in App Store Connect"
              echo "3. Your Team ID is correct"
              exit 1
            }
          
          # Verify IPA was created
          IPA_FILE=$(find "$CM_BUILD_DIR/build/ios/export" -name "*.ipa" | head -1)
          if [ -n "$IPA_FILE" ] && [ -f "$IPA_FILE" ]; then
            echo "✅ IPA created successfully!"
            echo "IPA file: $IPA_FILE"
            ls -lh "$IPA_FILE"
          else
            echo "❌ Error: IPA file not found"
            echo "Contents of export directory:"
            ls -la "$CM_BUILD_DIR/build/ios/export/" || echo "Export directory doesn't exist"
            exit 1
          fi
          
    artifacts:
      - build/ios/export/*.ipa
      - build/ios/Unity-iPhone.xcarchive
      - unity_build.log
      
    publishing:
      email:
        recipients:
          - amohamad343@gmail.com  # Your email for build notifications
        notify:
          success: true
          failure: true
      app_store_connect:
        # Uncomment and configure these when ready for automatic TestFlight uploads
        # You'll need to set up App Store Connect API keys in CodeMagic first
        # auth: integration
        # submit_to_testflight: true
        # beta_groups:
        #   - Internal Testers
