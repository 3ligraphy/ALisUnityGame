# CodeMagic Configuration for Unity iOS Build
# This configuration is optimized for Unity Personal (Free) license with Gmail login
# 
# ⚠️ SECURITY WARNING: This file contains your Unity credentials directly in the YAML file.
# This means your password will be visible in your Git repository!
# 
# RECOMMENDED: Use environment variables instead (more secure):
# 1. Go to CodeMagic dashboard > Your App > Settings > Environment variables
# 2. Add UNITY_EMAIL and UNITY_PASSWORD as secure environment variables
# 3. Remove the values below and use ${UNITY_EMAIL} and ${UNITY_PASSWORD} instead
#
# If you must use direct values, consider:
# - Adding codemagic.yaml to .gitignore (but then you can't version control it)
# - Using a private repository
# - Changing your Unity password after sharing this file
#
# TO USE THIS FILE: Replace the placeholder values below with your actual credentials

workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      # Base Unity version for license activation (must be a supported version)
      # This Unity is used ONLY to activate the license
      # The actual project build uses Unity 6000.2.15f1 installed via Unity Hub CLI
      unity: 2022.3.47f1
      vars:
        # Unity Student account credentials (includes headless build rights)
        # ⚠️ WARNING: These will be visible in your Git repository!
        UNITY_EMAIL: "ali.motawea@bue.edu.eg"  # Your Unity Student account
        UNITY_PASSWORD: "AJ1422003249aj*"      # Your Unity password
        
        # Bundle identifier - already configured for your app
        BUNDLE_ID: "com.failaka.games.adventure"
        
        # App Store Connect App ID (optional - for automatic TestFlight uploads)
        # APP_STORE_ID: ""  # Add this later if you want automatic uploads
        
      xcode: latest
      cocoapods: default
    
    cache:
      cache_paths:
        # Cache Unity 6000.2.15f1 installation to speed up subsequent builds
        # First build: ~30-50 min | Subsequent builds: ~15-30 min (saves 10-15 min)
        - /Applications/Unity/Hub/Editor/$UNITY_VERSION
        # Also cache Unity Hub to avoid re-downloading it
        - /Applications/Unity/Hub
      
    scripts:
      - name: Detect Unity Version from Project
        script: |
          echo "=========================================="
          echo "Detecting Unity version from project..."
          echo "=========================================="
          
          # Extract Unity version and changeset from ProjectSettings/ProjectVersion.txt
          UNITY_VERSION=$(echo $(sed -n '1p' ProjectSettings/ProjectVersion.txt) | cut -c 18-)
          UNITY_VERSION_CHANGESET=$(echo $(sed -n '2p' ProjectSettings/ProjectVersion.txt) | cut -d "(" -f2 | cut -d ")" -f1 | xargs)
          
          echo "Unity Version: $UNITY_VERSION"
          echo "Changeset: $UNITY_VERSION_CHANGESET"
          
          # Export to environment for use in subsequent scripts
          echo "UNITY_VERSION=$UNITY_VERSION" >> $CM_ENV
          echo "UNITY_VERSION_CHANGESET=$UNITY_VERSION_CHANGESET" >> $CM_ENV
          echo "UNITY_HOME=/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app" >> $CM_ENV
          
          echo "✅ Unity version detected: $UNITY_VERSION"
      
      - name: Activate Unity License
        script: |
          echo "=========================================="
          echo "Activating Unity license..."
          echo "=========================================="
          
          # Ensure license directory exists
          mkdir -p "$HOME/Library/Application Support/Unity"
          
          # Use the pre-installed Unity from environment (2022.3.47f1)
          TEMP_UNITY=$(find /Applications/Unity/Hub/Editor -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
          
          if [ -z "$TEMP_UNITY" ]; then
            echo "❌ No Unity installation found for license activation"
            echo "Available Unity installations:"
            ls -la /Applications/Unity/Hub/Editor/ 2>/dev/null || echo "No Unity Hub Editor directory found"
            exit 1
          fi
          
          echo "Using Unity at: $TEMP_UNITY"
          echo "Activating Unity Personal license with email: ${UNITY_EMAIL}"
          
          # Activate Unity license (Personal/Free license)
          # For Personal license, use -serial flag without serial number
          $TEMP_UNITY \
            -quit \
            -batchmode \
            -nographics \
            -serial \
            -username "${UNITY_EMAIL}" \
            -password "${UNITY_PASSWORD}" \
            -logFile - || true
          
          # Wait a moment for license file to be created
          sleep 3
          
          # Check if license was activated
          if [ -f "$HOME/Library/Application Support/Unity/Unity_lic.ulf" ]; then
            echo "✅ Unity license activated successfully"
            echo "License file created at: $HOME/Library/Application Support/Unity/Unity_lic.ulf"
          else
            echo "⚠️ License file not found, but continuing (activation may have succeeded)"
          fi
      
      - name: Install Unity Version via Unity Hub
        script: |
          echo "=========================================="
          echo "Installing Unity ${UNITY_VERSION}..."
          echo "=========================================="
          
          # Check if Unity version is already installed
          UNITY_PATH="/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app/Contents/MacOS/Unity"
          
          if [ -f "$UNITY_PATH" ]; then
            echo "✅ Unity ${UNITY_VERSION} already installed"
          else
            echo "Installing Unity ${UNITY_VERSION} with iOS and Android modules..."
            
            # Install Unity version with required modules
            yes Y | /Applications/Unity\ Hub.app/Contents/MacOS/Unity\ Hub -- \
              --headless install \
              --version $UNITY_VERSION \
              --changeset $UNITY_VERSION_CHANGESET \
              -a arm64
            
            # Install iOS and Android build support modules
            yes Y | /Applications/Unity\ Hub.app/Contents/MacOS/Unity\ Hub -- \
              --headless install-modules \
              --version $UNITY_VERSION \
              -m ios android \
              -a arm64
            
            echo "✅ Unity ${UNITY_VERSION} installation complete"
          fi
          
          # Verify installation
          if [ -f "$UNITY_PATH" ]; then
            echo "✅ Unity verified at: $UNITY_PATH"
            "$UNITY_PATH" -version || echo "Unity executable found"
          else
            echo "❌ Unity installation failed"
            exit 1
          fi
      
      - name: Build Unity Project for iOS
        script: |
          echo "=========================================="
          echo "Building Unity project for iOS..."
          echo "Using Unity Personal License (Free)"
          echo "=========================================="
          
          set -e
          
          # Use the Unity version we just installed
          UNITY_PATH="$UNITY_HOME/Contents/MacOS/Unity"
          
          # Verify Unity exists
          if [ ! -f "$UNITY_PATH" ]; then
            echo "❌ Error: Unity executable not found at: $UNITY_PATH"
            exit 1
          fi
          
          echo "✅ Using Unity ${UNITY_VERSION} at: $UNITY_PATH"
          
          # Build Unity project for iOS
          # For Personal license, we don't use -serial parameter
          echo "Starting Unity build (this may take 10-20 minutes)..."
          
          $UNITY_PATH \
            -quit \
            -batchmode \
            -nographics \
            -projectPath "$CM_BUILD_DIR" \
            -buildTarget iOS \
            -buildPath "$CM_BUILD_DIR/build/ios" \
            -username "${UNITY_EMAIL}" \
            -password "${UNITY_PASSWORD}" \
            -logFile "$CM_BUILD_DIR/unity_build.log" \
            || true
          
          # Check build result
          echo "=========================================="
          echo "Checking build log..."
          echo "=========================================="
          
          if [ -f "$CM_BUILD_DIR/unity_build.log" ]; then
            if grep -q "Build succeeded" "$CM_BUILD_DIR/unity_build.log"; then
              echo "✅ Unity build succeeded!"
            elif grep -q "Build failed" "$CM_BUILD_DIR/unity_build.log"; then
              echo "❌ Unity build failed. Last 50 lines of log:"
              tail -50 "$CM_BUILD_DIR/unity_build.log"
              exit 1
            else
              echo "⚠️  Build status unclear. Checking for Xcode project..."
              # Check if Xcode project was created
              if [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcodeproj" ] || [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcworkspace" ]; then
                echo "✅ Xcode project found - build likely succeeded"
              ls -la "$CM_BUILD_DIR/build/ios/"
              else
                echo "❌ Xcode project not found. Last 100 lines of log:"
                tail -100 "$CM_BUILD_DIR/unity_build.log"
                exit 1
              fi
            fi
          else
            echo "⚠️  Build log not found, but continuing..."
          fi
          
      - name: Configure Xcode Project
        script: |
          echo "=========================================="
          echo "Configuring Xcode project..."
          echo "=========================================="
          
          set -e
          cd "$CM_BUILD_DIR/build/ios"
          
          # Verify Xcode project exists
          if [ ! -d "Unity-iPhone.xcodeproj" ] && [ ! -d "Unity-iPhone.xcworkspace" ]; then
            echo "❌ Error: Xcode project not found!"
            echo "Contents of build/ios directory:"
            ls -la
            exit 1
          fi
          
          echo "✅ Xcode project found"
          
          # Find Info.plist
          INFO_PLIST=""
          if [ -f "Unity-iPhone/Info.plist" ]; then
            INFO_PLIST="Unity-iPhone/Info.plist"
          elif [ -f "Info.plist" ]; then
            INFO_PLIST="Info.plist"
          else
            INFO_PLIST=$(find . -name Info.plist -type f | head -1)
          fi
          
          if [ -z "$INFO_PLIST" ] || [ ! -f "$INFO_PLIST" ]; then
            echo "⚠️  Warning: Info.plist not found, but continuing..."
          else
            echo "Updating Info.plist: $INFO_PLIST"
            
            # Set bundle identifier
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set bundle identifier"
            
            # Set version
            /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set version"
            
            # Set build number (uses CodeMagic build number)
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${CM_BUILD_NUMBER}" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string ${CM_BUILD_NUMBER}" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set build number"
            
            # Set minimum iOS version
            /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 13.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 13.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set minimum iOS version"
            
            echo "✅ Info.plist updated"
            echo "Bundle ID: ${BUNDLE_ID}"
            echo "Version: 1.0.0"
            echo "Build Number: ${CM_BUILD_NUMBER}"
          fi
          
      - name: Install CocoaPods Dependencies
        script: |
          echo "=========================================="
          echo "Installing CocoaPods dependencies..."
          echo "=========================================="
          
          cd "$CM_BUILD_DIR/build/ios"
          
          # Check if Podfile exists (Unity sometimes creates one)
          if [ -f "Podfile" ]; then
            echo "Podfile found, installing dependencies..."
            pod install --repo-update || echo "⚠️  CocoaPods installation had issues, but continuing..."
          else
            echo "No Podfile found - this is normal for most Unity projects"
            echo "Skipping CocoaPods installation"
          fi
          
      - name: Build Xcode Archive
        script: |
          echo "=========================================="
          echo "Building Xcode archive..."
          echo "=========================================="
          
          set -e
          cd "$CM_BUILD_DIR/build/ios"
          
          # Determine if we have workspace or project
          if [ -d "Unity-iPhone.xcworkspace" ]; then
            echo "Using Xcode workspace"
            WORKSPACE="Unity-iPhone.xcworkspace"
            SCHEME="Unity-iPhone"
            
            # CodeMagic will handle code signing automatically during export
            # We build without signing here, signing happens during IPA export
            xcodebuild \
              -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
              archive \
              -quiet
              
          elif [ -d "Unity-iPhone.xcodeproj" ]; then
            echo "Using Xcode project"
            PROJECT="Unity-iPhone.xcodeproj"
            SCHEME="Unity-iPhone"
            
            # CodeMagic will handle code signing automatically during export
            xcodebuild \
              -project "$PROJECT" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
              archive \
              -quiet
          else
            echo "❌ Error: No Xcode project or workspace found"
            echo "Contents of build/ios:"
            ls -la
            exit 1
          fi
          
          # Verify archive was created
          if [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" ]; then
            echo "✅ Archive created successfully"
          else
            echo "❌ Error: Archive not created"
            exit 1
          fi
          
      - name: Export IPA
        script: |
          echo "=========================================="
          echo "Exporting IPA file..."
          echo "=========================================="
          
          set -e
          
          # Check if exportOptions.plist exists in project root
          if [ ! -f "$CM_BUILD_DIR/exportOptions.plist" ]; then
            echo "Creating exportOptions.plist for automatic code signing..."
            cat > "$CM_BUILD_DIR/exportOptions.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
          </dict>
          </plist>
          EOF
            echo "✅ Created exportOptions.plist with automatic signing"
          else
            echo "✅ Using existing exportOptions.plist"
            # Ensure automatic signing is set
            /usr/libexec/PlistBuddy -c "Set :signingStyle automatic" "$CM_BUILD_DIR/exportOptions.plist" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :signingStyle string automatic" "$CM_BUILD_DIR/exportOptions.plist" 2>/dev/null || \
            echo "⚠️  Could not set signingStyle, but continuing..."
          fi
          
          # Export IPA with automatic code signing
          # CodeMagic will use the Apple Developer integration you configured
          echo "Exporting archive to IPA with automatic code signing..."
          echo "CodeMagic will use your Apple Developer integration for signing..."
          xcodebuild -exportArchive \
            -archivePath "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcarchive" \
            -exportPath "$CM_BUILD_DIR/build/ios/export" \
            -exportOptionsPlist "$CM_BUILD_DIR/exportOptions.plist" \
            -quiet || {
              echo "❌ IPA export failed"
              echo "Check that:"
              echo "1. Apple Developer integration is configured in CodeMagic Settings > Integrations"
              echo "2. Your bundle ID matches the one in App Store Connect"
              echo "3. Your Team ID is correct"
              exit 1
            }
          
          # Verify IPA was created
          IPA_FILE=$(find "$CM_BUILD_DIR/build/ios/export" -name "*.ipa" | head -1)
          if [ -n "$IPA_FILE" ] && [ -f "$IPA_FILE" ]; then
            echo "✅ IPA created successfully!"
            echo "IPA file: $IPA_FILE"
            ls -lh "$IPA_FILE"
          else
            echo "❌ Error: IPA file not found"
            echo "Contents of export directory:"
            ls -la "$CM_BUILD_DIR/build/ios/export/" || echo "Export directory doesn't exist"
            exit 1
          fi
          
    artifacts:
      - build/ios/export/*.ipa
      - build/ios/Unity-iPhone.xcarchive
      - unity_build.log
      
    publishing:
      scripts:
        - name: Deactivate Unity License
          script: |
            echo "=========================================="
            echo "Returning Unity license..."
            echo "=========================================="
            
            # Return license to free up seat for future builds
            TEMP_UNITY=$(find /Applications/Unity/Hub/Editor -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
            
            if [ -n "$TEMP_UNITY" ]; then
              echo "Using Unity at: $TEMP_UNITY"
              $TEMP_UNITY \
                -quit \
                -batchmode \
                -nographics \
                -returnlicense \
                -username "${UNITY_EMAIL}" \
                -password "${UNITY_PASSWORD}" \
                -logFile - || echo "License return attempted"
              
              echo "✅ Unity license returned"
            else
              echo "⚠️ Unity not found, skipping license return"
            fi
      email:
        recipients:
          - amohamad343@gmail.com  # Your email for build notifications
        notify:
          success: true
          failure: true
      app_store_connect:
        # Uncomment and configure these when ready for automatic TestFlight uploads
        # You'll need to set up App Store Connect API keys in CodeMagic first
        # auth: integration
        # submit_to_testflight: true
        # beta_groups:
        #   - Internal Testers
