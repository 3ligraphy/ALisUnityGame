# CodeMagic Configuration for Unity iOS Build
# This configuration is optimized for Unity Personal (Free) license with Gmail login
# 
# ⚠️ SECURITY WARNING: This file contains your Unity credentials directly in the YAML file.
# This means your password will be visible in your Git repository!
# 
# RECOMMENDED: Use environment variables instead (more secure):
# 1. Go to CodeMagic dashboard > Your App > Settings > Environment variables
# 2. Add UNITY_EMAIL and UNITY_PASSWORD as secure environment variables
# 3. Remove the values below and use ${UNITY_EMAIL} and ${UNITY_PASSWORD} instead
#
# If you must use direct values, consider:
# - Adding codemagic.yaml to .gitignore (but then you can't version control it)
# - Using a private repository
# - Changing your Unity password after sharing this file
#
# TO USE THIS FILE: Replace the placeholder values below with your actual credentials

workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    integrations:
      app_store_connect: Code Magic illusionaire  # Uses your CodeMagic Apple Developer integration
    environment:
      # Base Unity version for license activation (must be a supported version)
      # This Unity is used ONLY to activate the license
      # The actual project build uses Unity 6000.2.15f1 installed via Unity Hub CLI
      unity: 2022.3.47f1
      vars:
        # Unity Student account credentials (includes headless build rights)
        # ⚠️ WARNING: These will be visible in your Git repository!
        UNITY_EMAIL: "ali.motawea@bue.edu.eg"  # Your Unity Student account
        UNITY_PASSWORD: "AJ1422003249aj*"      # Your Unity password
        
        # Bundle identifier - already configured for your app
        BUNDLE_ID: "com.failaka.games.adventure"
        
        # App Store Connect App ID (optional - for automatic TestFlight uploads)
        # APP_STORE_ID: ""  # Add this later if you want automatic uploads
        
      xcode: latest
      cocoapods: default
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.failaka.games.adventure
    
    cache:
      cache_paths:
        # Cache Unity 6000.2.15f1 installation to speed up subsequent builds
        # First build: ~30-50 min | Subsequent builds: ~15-30 min (saves 10-15 min)
        - /Applications/Unity/Hub/Editor/$UNITY_VERSION
        # Also cache Unity Hub to avoid re-downloading it
        - /Applications/Unity/Hub
      
    scripts:
      - name: Detect Unity Version from Project
        script: |
          echo "=========================================="
          echo "Detecting Unity version from project..."
          echo "=========================================="
          
          # Extract Unity version and changeset from ProjectSettings/ProjectVersion.txt
          UNITY_VERSION=$(echo $(sed -n '1p' ProjectSettings/ProjectVersion.txt) | cut -c 18-)
          UNITY_VERSION_CHANGESET=$(echo $(sed -n '2p' ProjectSettings/ProjectVersion.txt) | cut -d "(" -f2 | cut -d ")" -f1 | xargs)
          
          echo "Unity Version: $UNITY_VERSION"
          echo "Changeset: $UNITY_VERSION_CHANGESET"
          
          # Export to environment for use in subsequent scripts
          echo "UNITY_VERSION=$UNITY_VERSION" >> $CM_ENV
          echo "UNITY_VERSION_CHANGESET=$UNITY_VERSION_CHANGESET" >> $CM_ENV
          echo "UNITY_HOME=/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app" >> $CM_ENV
          
          echo "✅ Unity version detected: $UNITY_VERSION"
      
      - name: Activate Unity License
        script: |
          echo "=========================================="
          echo "Activating Unity license..."
          echo "=========================================="
          
          # Ensure license directory exists
          mkdir -p "$HOME/Library/Application Support/Unity"
          
          # Use the pre-installed Unity from environment (2022.3.47f1)
          TEMP_UNITY=$(find /Applications/Unity/Hub/Editor -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
          
          if [ -z "$TEMP_UNITY" ]; then
            echo "❌ No Unity installation found for license activation"
            echo "Available Unity installations:"
            ls -la /Applications/Unity/Hub/Editor/ 2>/dev/null || echo "No Unity Hub Editor directory found"
            exit 1
          fi
          
          echo "Using Unity at: $TEMP_UNITY"
          echo "Activating Unity Personal license with email: ${UNITY_EMAIL}"
          
          # Activate Unity license (Personal/Free license)
          # For Personal license, use -serial flag without serial number
          $TEMP_UNITY \
            -quit \
            -batchmode \
            -nographics \
            -serial \
            -username "${UNITY_EMAIL}" \
            -password "${UNITY_PASSWORD}" \
            -logFile - || true
          
          # Wait a moment for license file to be created
          sleep 3
          
          # Check if license was activated
          if [ -f "$HOME/Library/Application Support/Unity/Unity_lic.ulf" ]; then
            echo "✅ Unity license activated successfully"
            echo "License file created at: $HOME/Library/Application Support/Unity/Unity_lic.ulf"
          else
            echo "⚠️ License file not found, but continuing (activation may have succeeded)"
          fi
      
      - name: Install Unity Version via Unity Hub
        script: |
          echo "=========================================="
          echo "Installing Unity ${UNITY_VERSION}..."
          echo "=========================================="
          
          # Check if Unity version is already installed
          UNITY_PATH="/Applications/Unity/Hub/Editor/${UNITY_VERSION}/Unity.app/Contents/MacOS/Unity"
          
          if [ -f "$UNITY_PATH" ]; then
            echo "✅ Unity ${UNITY_VERSION} already installed"
          else
            echo "Installing Unity ${UNITY_VERSION} with iOS module only..."
            
            # Install Unity version with required modules
            yes Y | /Applications/Unity\ Hub.app/Contents/MacOS/Unity\ Hub -- \
              --headless install \
              --version $UNITY_VERSION \
              --changeset $UNITY_VERSION_CHANGESET \
              -a arm64
            
            # Install iOS Build Support module only (no Android for iOS-only builds)
            yes Y | /Applications/Unity\ Hub.app/Contents/MacOS/Unity\ Hub -- \
              --headless install-modules \
              --version $UNITY_VERSION \
              -m ios \
              -a arm64
            
            echo "✅ Unity ${UNITY_VERSION} installation complete"
          fi
          
          # Verify installation
          if [ -f "$UNITY_PATH" ]; then
            echo "✅ Unity verified at: $UNITY_PATH"
            "$UNITY_PATH" -version || echo "Unity executable found"
          else
            echo "❌ Unity installation failed"
            exit 1
          fi
      
      - name: Build Unity Project for iOS
        script: |
          echo "=========================================="
          echo "Building Unity project for iOS..."
          echo "Using Unity Personal License (Free)"
          echo "=========================================="
          
          set -e
          
          # Use the Unity version we just installed
          UNITY_PATH="$UNITY_HOME/Contents/MacOS/Unity"
          
          # Verify Unity exists
          if [ ! -f "$UNITY_PATH" ]; then
            echo "❌ Error: Unity executable not found at: $UNITY_PATH"
            exit 1
          fi
          
          echo "✅ Using Unity ${UNITY_VERSION} at: $UNITY_PATH"
          
          # Set environment variables for build script
          export IOS_BUILD_PATH="$CM_BUILD_DIR/build/ios"
          export BUILD_NUMBER="${CM_BUILD_NUMBER}"
          
          # Build Unity project for iOS using BuildScript.cs
          echo "Starting Unity build (this may take 10-20 minutes)..."
          echo "Build will use -executeMethod BuildScript.BuildIOS"
          
          $UNITY_PATH \
            -quit \
            -batchmode \
            -nographics \
            -projectPath "$CM_BUILD_DIR" \
            -executeMethod BuildScript.BuildIOS \
            -logFile "$CM_BUILD_DIR/unity_build.log" \
            || true
          
          # Check build result
          echo "=========================================="
          echo "Checking build log..."
          echo "=========================================="
          
          if [ -f "$CM_BUILD_DIR/unity_build.log" ]; then
            if grep -q "Build succeeded" "$CM_BUILD_DIR/unity_build.log"; then
              echo "✅ Unity build succeeded!"
            elif grep -q "Build failed" "$CM_BUILD_DIR/unity_build.log"; then
              echo "❌ Unity build failed. Last 50 lines of log:"
              tail -50 "$CM_BUILD_DIR/unity_build.log"
              exit 1
            else
              echo "⚠️  Build status unclear. Checking for Xcode project..."
              # Check if Xcode project was created
              if [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcodeproj" ] || [ -d "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcworkspace" ]; then
                echo "✅ Xcode project found - build likely succeeded"
              ls -la "$CM_BUILD_DIR/build/ios/"
              else
                echo "❌ Xcode project not found. Last 100 lines of log:"
                tail -100 "$CM_BUILD_DIR/unity_build.log"
                exit 1
              fi
            fi
          else
            echo "⚠️  Build log not found, but continuing..."
          fi
      
      - name: Configure Xcode Project
        script: |
          echo "=========================================="
          echo "Configuring Xcode project..."
          echo "=========================================="
          
          set -e
          cd "$CM_BUILD_DIR/build/ios"
          
          # Verify Xcode project exists
          if [ ! -d "Unity-iPhone.xcodeproj" ] && [ ! -d "Unity-iPhone.xcworkspace" ]; then
            echo "❌ Error: Xcode project not found!"
            echo "Contents of build/ios directory:"
            ls -la
            exit 1
          fi
          
          echo "✅ Xcode project found"
          
          # Find Info.plist
          INFO_PLIST=""
          if [ -f "Unity-iPhone/Info.plist" ]; then
            INFO_PLIST="Unity-iPhone/Info.plist"
          elif [ -f "Info.plist" ]; then
            INFO_PLIST="Info.plist"
          else
            INFO_PLIST=$(find . -name Info.plist -type f | head -1)
          fi
          
          if [ -z "$INFO_PLIST" ] || [ ! -f "$INFO_PLIST" ]; then
            echo "⚠️  Warning: Info.plist not found, but continuing..."
          else
            echo "Updating Info.plist: $INFO_PLIST"
            
            # Set build number with fallback (CRITICAL for App Store Connect)
            BUILD_NUM="${CM_BUILD_NUMBER:-${BUILD_NUMBER:-1}}"
            echo "Setting build number to: $BUILD_NUM"
            
            # Set bundle identifier
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string ${BUNDLE_ID}" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set bundle identifier"
            
            # Set version
            /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set version"
            
            # Set build number (MUST exist for App Store Connect)
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUM" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $BUILD_NUM" "$INFO_PLIST" 2>/dev/null || {
              echo "❌ ERROR: Failed to set CFBundleVersion!"
              exit 1
            }
            
            # Verify CFBundleVersion was set
            VERIFY_BUILD_NUM=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST" 2>/dev/null)
            if [ -z "$VERIFY_BUILD_NUM" ]; then
              echo "❌ ERROR: CFBundleVersion is still empty after setting!"
              exit 1
            fi
            echo "✅ CFBundleVersion set to: $VERIFY_BUILD_NUM"
            
            # Set minimum iOS version
            /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 13.0" "$INFO_PLIST" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 13.0" "$INFO_PLIST" 2>/dev/null || \
            echo "⚠️  Could not set minimum iOS version"
            
            echo "✅ Info.plist updated"
            echo "Bundle ID: ${BUNDLE_ID}"
            echo "Version: 1.0.0"
            echo "Build Number: ${CM_BUILD_NUMBER}"
          fi
      
      - name: Set up code signing settings on Xcode project
        script: |
          echo "=========================================="
          echo "Applying provisioning profiles to Xcode..."
          echo "=========================================="
          
          cd "$CM_BUILD_DIR/build/ios"
          
          # Apply the fetched provisioning profiles to the Xcode project
          # This uses CodeMagic's xcode-project tool to automatically configure signing
          xcode-project use-profiles
          
          echo "✅ Code signing profiles applied to Xcode project"
      
      - name: Fix UnityFramework automatic signing
        script: |
          echo "=========================================="
          echo "Setting UnityFramework to automatic signing..."
          echo "=========================================="
          
          cd "$CM_BUILD_DIR/build/ios"
          
          PROJECT_FILE="Unity-iPhone.xcodeproj/project.pbxproj"
          
          if [ ! -f "$PROJECT_FILE" ]; then
            echo "❌ Error: project.pbxproj not found"
            exit 1
          fi
          
          echo "Modifying UnityFramework signing to automatic..."
          cp "$PROJECT_FILE" "${PROJECT_FILE}.backup"
          
          # Use awk to change CODE_SIGN_STYLE for UnityFramework
          awk '
            /UnityFramework/ {framework=1}
            framework && /CODE_SIGN_STYLE = Manual;/ {gsub(/Manual/, "Automatic")}
            framework && /^[[:space:]]*};$/ {framework=0}
            {print}
          ' "$PROJECT_FILE" > "${PROJECT_FILE}.tmp" && mv "${PROJECT_FILE}.tmp" "$PROJECT_FILE"
          
          echo "✅ UnityFramework set to automatic signing"
          
      - name: Install CocoaPods Dependencies
        script: |
          echo "=========================================="
          echo "Installing CocoaPods dependencies..."
          echo "=========================================="
          
          cd "$CM_BUILD_DIR/build/ios"
          
          # Check if Podfile exists (Unity sometimes creates one)
          if [ -f "Podfile" ]; then
            echo "Podfile found, installing dependencies..."
            pod install --repo-update || echo "⚠️  CocoaPods installation had issues, but continuing..."
          else
            echo "No Podfile found - this is normal for most Unity projects"
            echo "Skipping CocoaPods installation"
          fi
          
      - name: Build IPA
        script: |
          echo "=========================================="
          echo "Building IPA with xcode-project..."
          echo "=========================================="
          
          set -e
          
          # Use CodeMagic's xcode-project tool to build IPA
          xcode-project build-ipa \
            --project "$CM_BUILD_DIR/build/ios/Unity-iPhone.xcodeproj" \
            --scheme "Unity-iPhone"
          
          echo "✅ IPA built successfully"
      
    artifacts:
      - build/ios/ipa/*.ipa
      - unity_build.log
      
    publishing:
      scripts:
        - name: Deactivate Unity License
          script: |
            echo "=========================================="
            echo "Returning Unity license..."
            echo "=========================================="
            
            # Return license to free up seat for future builds
            TEMP_UNITY=$(find /Applications/Unity/Hub/Editor -name Unity -type f -path "*/Unity.app/Contents/MacOS/Unity" 2>/dev/null | head -1)
            
            if [ -n "$TEMP_UNITY" ]; then
              echo "Using Unity at: $TEMP_UNITY"
              $TEMP_UNITY \
                -quit \
                -batchmode \
                -nographics \
                -returnlicense \
                -username "${UNITY_EMAIL}" \
                -password "${UNITY_PASSWORD}" \
                -logFile - || echo "License return attempted"
              
              echo "✅ Unity license returned"
            else
              echo "⚠️ Unity not found, skipping license return"
            fi
      email:
        recipients:
          - amohamad343@gmail.com  # Your email for build notifications
        notify:
          success: true
          failure: true
      app_store_connect:
        # Automatic TestFlight uploads using your CodeMagic Apple Developer integration
        auth: integration  # Uses the integration you set up in CodeMagic UI
        submit_to_testflight: true
        # beta_groups:  # Uncomment to distribute to specific beta groups
        #   - Internal Testers
